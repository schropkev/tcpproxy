#!/bin/sh
#
#  tcpproxy
#
#  tcpproxy is a simple tcp connection proxy which combines the
#  features of rinetd and 6tunnel. tcpproxy supports IPv4 and
#  IPv6 and also supports connections from IPv6 to IPv4
#  endpoints and vice versa.
#
#
#  Copyright (C) 2010-2015 Christian Pointner <equinox@spreadspace.org>
#
#  This file is part of tcpproxy.
#
#  tcpproxy is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  any later version.
#
#  tcpproxy is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with tcpproxy. If not, see <http://www.gnu.org/licenses/>.
#

TARGET=`uname -s`
EBUILD_COMPAT=0

USE_CLANG=0

PREFIX='/usr/local'
BINDIR=''
SYSTEMDDIR=''
ETCDIR=''
MANDIR=''
INSTALLMANPAGE=1
EXAMPLESDIR=''
INSTALLEXAMPLES=1

print_usage() {
  echo "configure --help                    print this"
  echo "          --target=<TARGET>         build target i.e. Linux (default: autodetect)"
  echo "          --prefix=<PREFIX>         the installation prefix (default: /usr/local)"
  echo "          --bindir=<DIR>            the path to the bin directory (default: $PREFIX/bin)"
  echo "          --systemddir=<DIR>        the path to the systemd service unit directory (default: /usr/lib/systemd/system)"
  echo "          --sysconfdir=<DIR>        the path to the system configuration directory (default: $PREFIX/etc"
  echo "          --mandir=<DIR>            the path to the system man pages (default: $PREFIX/share/man)"
  echo "          --no-manpage              dont't install manpage"
  echo "          --examplesdir=<DIR>       the path to the examples files (default: $PREFIX/share/examples)"
  echo "          --no-examples             dont't install example files"
  echo "          --use-clang               use clang/llvm as compiler/linker"
}

for arg
do
  case $arg in
  --target=*)
    TARGET=${arg#--target=}
  ;;
  --use-clang)
    USE_CLANG=1
  ;;
  --prefix=*)
    PREFIX=${arg#--prefix=}
  ;;
  --bindir=*)
    BINDIR=${arg#--bindir=}
  ;;
  --systemddir=*)
    SYSTEMDDIR=${arg#--systemddir=}
  ;;
  --sysconfdir=*)
    ETCDIR=${arg#--sysconfdir=}
  ;;
  --mandir=*)
    MANDIR=${arg#--mandir=}
  ;;
  --no-manpage)
    INSTALLMANPAGE=0
  ;;
  --examplesdir=*)
    EXAMPLESDIR=${arg#--examplesdir=}
  ;;
  --no-examples)
    INSTALLEXAMPLES=0
  ;;
  --ebuild-compat)
    EBUILD_COMPAT=1
  ;;
  --help)
    print_usage
    exit 0
  ;;
  *)
    ERRORS="$ERRORS $arg"
  ;;
  esac
done

if [ -n "$ERRORS" ] && [ $EBUILD_COMPAT -ne 1 ]; then
  for error in $ERRORS; do
    echo "Unknown argument: $error"
  done

  print_usage
  exit 1
fi

if [ $USE_CLANG -eq 0 ]; then
  CFLAGS='-g -Wall -O2'
  LDFLAGS='-g -Wall -O2'
  COMPILER='gcc'
else
  CFLAGS='-g -O2'
  LDFLAGS='-g -O2'
  COMPILER='clang'
fi

rm -f config.h
rm -f include.mk
case $TARGET in
  Linux)
  ;;
  OpenBSD|FreeBSD|NetBSD|GNU/kFreeBSD)
    CFLAGS=$CFLAGS' -I/usr/local/include'
    LDFLAGS=$LDFLAGS' -L/usr/local/lib'
  ;;
  *)
    echo "platform not supported"
    exit 1;
  ;;
esac

if [ -z "$BINDIR" ]; then
  BINDIR=$PREFIX/bin
fi

if [ -z "$SYSTEMDDIR" ]; then
  SYSTEMDDIR=/usr/lib/systemd/system
fi

if [ -z "$ETCDIR" ]; then
  ETCDIR=$PREFIX/etc
fi

if [ -z "$MANDIR" ]; then
  MANDIR=$PREFIX/share/man
fi

if [ -z "$EXAMPLESDIR" ]; then
  EXAMPLESDIR=$PREFIX/share/examples
fi

cat > include.mk <<EOF
# this file was created automatically
# do not edit this file directly
# use ./configure instead

TARGET := $TARGET
CC := $COMPILER
CFLAGS := $CFLAGS
LDFLAGS := $LDFLAGS
STRIP := strip
INSTALL := install
RAGEL := ragel

prefix := '$PREFIX'
BINDIR := '$BINDIR'
SYSTEMDDIR := '$SYSTEMDDIR'
ETCDIR := '$ETCDIR'
EOF

if [ $INSTALLMANPAGE -eq 1 ]; then
    echo "MANDIR := '$MANDIR'" >> include.mk
    echo "installing manpage"
else
    echo "not installing manpage"
fi

if [ $INSTALLEXAMPLES -eq 1 ]; then
    echo "EXAMPLESDIR := '$EXAMPLESDIR'" >> include.mk
    echo "installing example files"
else
    echo "not installing example files"
fi

VERSION=`cat ../version`
if which git >/dev/null; then
    GIT_HASH=`git rev-parse HEAD 2> /dev/null`
    if [ -n "$GIT_HASH" ]; then
        VERSION="$VERSION (git $GIT_HASH)"
    fi
fi

HOSTNAME=`hostname`
DATE=`date +"%d.%m.%Y %H:%M:%S %Z"`

cat > config.h <<EOF
/*
 * tcpproxy config header
 *
 * this file was created automatically
 * do not edit this file directly
 * use ./configure instead
 */

#ifndef TCPPROXY_config_h_INCLUDED
#define TCPPROXY_config_h_INCLUDED

#define VERSION_STRING_0 "tcpproxy version $VERSION"
#define VERSION_STRING_1 "built on $HOSTNAME, $DATE"

#define TARGET "$TARGET"
#define PREFIX "$PREFIX"
#define BINDIR "$BINDIR"
#define SYSTEMDDIR "$SYSTEMDDIR"
#define ETCDIR "$ETCDIR"
#define CONFFILE "$ETCDIR/tcpproxy.conf"

#endif
EOF

exit 0
